{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{i18n}from\"@lingui/core\";import React,{useState,useCallback}from'react';import{useParams,useRouteMatch}from'react-router-dom';import styled from'styled-components';import useRequest from'hooks/useRequest';import useSelected from'hooks/useSelected';import SelectableCard from'../SelectableCard';import Wizard from'../Wizard/Wizard';import SelectResourceStep from'../AddRole/SelectResourceStep';import SelectRoleStep from'../AddRole/SelectRoleStep';import getResourceAccessConfig from'./getResourceAccessConfig';import{jsx as _jsx}from\"react/jsx-runtime\";var Grid=styled.div(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  display: grid;\\n  grid-gap: 20px;\\n  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));\\n\"])));function UserAndTeamAccessAdd(_ref){var _resourcesSelected$,_resourcesSelected$$s,_resourcesSelected$2;var title=_ref.title,onFetchData=_ref.onFetchData,apiModel=_ref.apiModel,onClose=_ref.onClose,onError=_ref.onError;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),selectedResourceType=_useState2[0],setSelectedResourceType=_useState2[1];var _useState3=useState(1),_useState4=_slicedToArray(_useState3,2),stepIdReached=_useState4[0],setStepIdReached=_useState4[1];var _useParams=useParams(),userId=_useParams.id;var teamsRouteMatch=useRouteMatch({path:'/teams/:id/roles',exact:true});var _useSelected=useSelected([]),resourcesSelected=_useSelected.selected,handleResourceSelect=_useSelected.handleSelect;var _useSelected2=useSelected([]),rolesSelected=_useSelected2.selected,handleRoleSelect=_useSelected2.handleSelect;var _useRequest=useRequest(useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var roleRequests,resourceRolesTypes;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:roleRequests=[];resourceRolesTypes=resourcesSelected.flatMap(function(resource){return Object.values(resource.summary_fields.object_roles);});rolesSelected.map(function(role){return resourceRolesTypes.forEach(function(rolename){if(rolename.name===role.name){roleRequests.push(apiModel.associateRole(userId,rolename.id));}});});_context.next=5;return Promise.all(roleRequests);case 5:onFetchData();case 6:case\"end\":return _context.stop();}}},_callee);})),[onFetchData,rolesSelected,apiModel,userId,resourcesSelected]),{}),handleWizardSave=_useRequest.request,saveError=_useRequest.error;// Object roles can be user only, so we remove them when\n// showing role choices for team access\nvar selectableRoles=_objectSpread({},(_resourcesSelected$=resourcesSelected[0])===null||_resourcesSelected$===void 0?void 0:(_resourcesSelected$$s=_resourcesSelected$.summary_fields)===null||_resourcesSelected$$s===void 0?void 0:_resourcesSelected$$s.object_roles);if(teamsRouteMatch&&((_resourcesSelected$2=resourcesSelected[0])===null||_resourcesSelected$2===void 0?void 0:_resourcesSelected$2.type)==='organization'){Object.keys(selectableRoles).forEach(function(key){if(selectableRoles[key].user_only){delete selectableRoles[key];}});}var steps=[{id:1,name:/*i18n*/i18n._(\"Add resource type\"),component:/*#__PURE__*/_jsx(Grid,{children:getResourceAccessConfig().map(function(resource){return/*#__PURE__*/_jsx(SelectableCard,{isSelected:resource.selectedResource===(selectedResourceType===null||selectedResourceType===void 0?void 0:selectedResourceType.selectedResource),label:resource.label,dataCy:\"add-role-\".concat(resource.selectedResource),onClick:function onClick(){return setSelectedResourceType(resource);}},resource.selectedResource);})}),enableNext:selectedResourceType!==null},{id:2,name:/*i18n*/i18n._(\"Select items from list\"),component:selectedResourceType&&/*#__PURE__*/_jsx(SelectResourceStep,{searchColumns:selectedResourceType.searchColumns,sortColumns:selectedResourceType.sortColumns,displayKey:\"name\",onRowClick:handleResourceSelect,fetchItems:selectedResourceType.fetchItems,fetchOptions:selectedResourceType.fetchOptions,selectedLabel:/*i18n*/i18n._(\"Selected\"),selectedResourceRows:resourcesSelected,sortedColumnKey:\"username\"}),enableNext:resourcesSelected.length>0,canJumpTo:stepIdReached>=2},{id:3,name:/*i18n*/i18n._(\"Select roles to apply\"),component:(resourcesSelected===null||resourcesSelected===void 0?void 0:resourcesSelected.length)>0&&/*#__PURE__*/_jsx(SelectRoleStep,{onRolesClick:handleRoleSelect,roles:selectableRoles,selectedListKey:selectedResourceType==='users'?'username':'name',selectedListLabel:/*i18n*/i18n._(\"Selected\"),selectedResourceRows:resourcesSelected,selectedRoleRows:rolesSelected}),nextButtonText:/*i18n*/i18n._(\"Save\"),canJumpTo:stepIdReached>=3}];if(saveError){onError(saveError);onClose();}return/*#__PURE__*/_jsx(Wizard,{isOpen:true,title:title,steps:steps,onClose:onClose,onNext:function onNext(_ref3){var id=_ref3.id;return setStepIdReached(stepIdReached<id?id:stepIdReached);},onSave:handleWizardSave});}export default UserAndTeamAccessAdd;","map":{"version":3,"names":["React","useState","useCallback","useParams","useRouteMatch","styled","useRequest","useSelected","SelectableCard","Wizard","SelectResourceStep","SelectRoleStep","getResourceAccessConfig","jsx","_jsx","Grid","div","_templateObject","_taggedTemplateLiteral","UserAndTeamAccessAdd","_ref","_resourcesSelected$","_resourcesSelected$$s","_resourcesSelected$2","title","onFetchData","apiModel","onClose","onError","_useState","_useState2","_slicedToArray","selectedResourceType","setSelectedResourceType","_useState3","_useState4","stepIdReached","setStepIdReached","_useParams","userId","id","teamsRouteMatch","path","exact","_useSelected","resourcesSelected","selected","handleResourceSelect","handleSelect","_useSelected2","rolesSelected","handleRoleSelect","_useRequest","_asyncToGenerator","_regeneratorRuntime","mark","_callee","roleRequests","resourceRolesTypes","wrap","_callee$","_context","prev","next","flatMap","resource","Object","values","summary_fields","object_roles","map","role","forEach","rolename","name","push","associateRole","Promise","all","stop","handleWizardSave","request","saveError","error","selectableRoles","_objectSpread","type","keys","key","user_only","steps","i18n","_","component","children","isSelected","selectedResource","label","dataCy","concat","onClick","enableNext","searchColumns","sortColumns","displayKey","onRowClick","fetchItems","fetchOptions","selectedLabel","selectedResourceRows","sortedColumnKey","length","canJumpTo","onRolesClick","roles","selectedListKey","selectedListLabel","selectedRoleRows","nextButtonText","isOpen","onNext","_ref3","onSave"],"sources":["/awx_devel/awx/ui/src/components/UserAndTeamAccessAdd/UserAndTeamAccessAdd.js"],"sourcesContent":["import React, { useState, useCallback } from 'react';\nimport { t } from '@lingui/macro';\nimport { useParams, useRouteMatch } from 'react-router-dom';\nimport styled from 'styled-components';\nimport useRequest from 'hooks/useRequest';\nimport useSelected from 'hooks/useSelected';\nimport SelectableCard from '../SelectableCard';\nimport Wizard from '../Wizard/Wizard';\nimport SelectResourceStep from '../AddRole/SelectResourceStep';\nimport SelectRoleStep from '../AddRole/SelectRoleStep';\nimport getResourceAccessConfig from './getResourceAccessConfig';\n\nconst Grid = styled.div`\n  display: grid;\n  grid-gap: 20px;\n  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));\n`;\n\nfunction UserAndTeamAccessAdd({\n  title,\n  onFetchData,\n  apiModel,\n  onClose,\n  onError,\n}) {\n  const [selectedResourceType, setSelectedResourceType] = useState(null);\n  const [stepIdReached, setStepIdReached] = useState(1);\n  const { id: userId } = useParams();\n  const teamsRouteMatch = useRouteMatch({\n    path: '/teams/:id/roles',\n    exact: true,\n  });\n\n  const { selected: resourcesSelected, handleSelect: handleResourceSelect } =\n    useSelected([]);\n\n  const { selected: rolesSelected, handleSelect: handleRoleSelect } =\n    useSelected([]);\n\n  const { request: handleWizardSave, error: saveError } = useRequest(\n    useCallback(async () => {\n      const roleRequests = [];\n      const resourceRolesTypes = resourcesSelected.flatMap((resource) =>\n        Object.values(resource.summary_fields.object_roles)\n      );\n\n      rolesSelected.map((role) =>\n        resourceRolesTypes.forEach((rolename) => {\n          if (rolename.name === role.name) {\n            roleRequests.push(apiModel.associateRole(userId, rolename.id));\n          }\n        })\n      );\n\n      await Promise.all(roleRequests);\n      onFetchData();\n    }, [onFetchData, rolesSelected, apiModel, userId, resourcesSelected]),\n    {}\n  );\n\n  // Object roles can be user only, so we remove them when\n  // showing role choices for team access\n  const selectableRoles = {\n    ...resourcesSelected[0]?.summary_fields?.object_roles,\n  };\n  if (teamsRouteMatch && resourcesSelected[0]?.type === 'organization') {\n    Object.keys(selectableRoles).forEach((key) => {\n      if (selectableRoles[key].user_only) {\n        delete selectableRoles[key];\n      }\n    });\n  }\n\n  const steps = [\n    {\n      id: 1,\n      name: t`Add resource type`,\n      component: (\n        <Grid>\n          {getResourceAccessConfig().map((resource) => (\n            <SelectableCard\n              key={resource.selectedResource}\n              isSelected={\n                resource.selectedResource ===\n                selectedResourceType?.selectedResource\n              }\n              label={resource.label}\n              dataCy={`add-role-${resource.selectedResource}`}\n              onClick={() => setSelectedResourceType(resource)}\n            />\n          ))}\n        </Grid>\n      ),\n      enableNext: selectedResourceType !== null,\n    },\n    {\n      id: 2,\n      name: t`Select items from list`,\n      component: selectedResourceType && (\n        <SelectResourceStep\n          searchColumns={selectedResourceType.searchColumns}\n          sortColumns={selectedResourceType.sortColumns}\n          displayKey=\"name\"\n          onRowClick={handleResourceSelect}\n          fetchItems={selectedResourceType.fetchItems}\n          fetchOptions={selectedResourceType.fetchOptions}\n          selectedLabel={t`Selected`}\n          selectedResourceRows={resourcesSelected}\n          sortedColumnKey=\"username\"\n        />\n      ),\n      enableNext: resourcesSelected.length > 0,\n      canJumpTo: stepIdReached >= 2,\n    },\n    {\n      id: 3,\n      name: t`Select roles to apply`,\n      component: resourcesSelected?.length > 0 && (\n        <SelectRoleStep\n          onRolesClick={handleRoleSelect}\n          roles={selectableRoles}\n          selectedListKey={\n            selectedResourceType === 'users' ? 'username' : 'name'\n          }\n          selectedListLabel={t`Selected`}\n          selectedResourceRows={resourcesSelected}\n          selectedRoleRows={rolesSelected}\n        />\n      ),\n      nextButtonText: t`Save`,\n      canJumpTo: stepIdReached >= 3,\n    },\n  ];\n\n  if (saveError) {\n    onError(saveError);\n    onClose();\n  }\n\n  return (\n    <Wizard\n      isOpen\n      title={title}\n      steps={steps}\n      onClose={onClose}\n      onNext={({ id }) =>\n        setStepIdReached(stepIdReached < id ? id : stepIdReached)\n      }\n      onSave={handleWizardSave}\n    />\n  );\n}\n\nexport default UserAndTeamAccessAdd;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}