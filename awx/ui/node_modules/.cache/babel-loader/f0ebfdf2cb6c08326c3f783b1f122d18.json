{"ast":null,"code":"import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import useWebsocket from'hooks/useWebsocket';import useThrottle from'hooks/useThrottle';export default function useWsWorkflowApprovals(initialWorkflowApprovals,fetchWorkflowApprovals){var _useState=useState(initialWorkflowApprovals),_useState2=_slicedToArray(_useState,2),workflowApprovals=_useState2[0],setWorkflowApprovals=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),reloadEntireList=_useState4[0],setReloadEntireList=_useState4[1];var throttledListRefresh=useThrottle(reloadEntireList,1000);var lastMessage=useWebsocket({jobs:['status_changed'],control:['limit_reached_1']});useEffect(function(){setWorkflowApprovals(initialWorkflowApprovals);},[initialWorkflowApprovals]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(throttledListRefresh){_context.next=2;break;}return _context.abrupt(\"return\");case 2:setReloadEntireList(false);fetchWorkflowApprovals();case 4:case\"end\":return _context.stop();}}},_callee);}))();},[throttledListRefresh,fetchWorkflowApprovals]);useEffect(function(){if(!((lastMessage===null||lastMessage===void 0?void 0:lastMessage.type)==='workflow_approval')){return;}var index=workflowApprovals.findIndex(function(p){return p.id===lastMessage.unified_job_id;});if(index>-1&&!['new','pending','waiting','running'].includes(lastMessage.status)||index===-1&&lastMessage.status==='pending'){setReloadEntireList(true);}},// eslint-disable-next-line react-hooks/exhaustive-deps,\n[lastMessage]);return workflowApprovals;}","map":{"version":3,"names":["useState","useEffect","useWebsocket","useThrottle","useWsWorkflowApprovals","initialWorkflowApprovals","fetchWorkflowApprovals","_useState","_useState2","_slicedToArray","workflowApprovals","setWorkflowApprovals","_useState3","_useState4","reloadEntireList","setReloadEntireList","throttledListRefresh","lastMessage","jobs","control","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","abrupt","stop","type","index","findIndex","p","id","unified_job_id","includes","status"],"sources":["/awx_devel/awx/ui/src/screens/WorkflowApproval/WorkflowApprovalList/useWsWorkflowApprovals.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport useWebsocket from 'hooks/useWebsocket';\nimport useThrottle from 'hooks/useThrottle';\n\nexport default function useWsWorkflowApprovals(\n  initialWorkflowApprovals,\n  fetchWorkflowApprovals\n) {\n  const [workflowApprovals, setWorkflowApprovals] = useState(\n    initialWorkflowApprovals\n  );\n  const [reloadEntireList, setReloadEntireList] = useState(false);\n  const throttledListRefresh = useThrottle(reloadEntireList, 1000);\n  const lastMessage = useWebsocket({\n    jobs: ['status_changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setWorkflowApprovals(initialWorkflowApprovals);\n  }, [initialWorkflowApprovals]);\n\n  useEffect(() => {\n    (async () => {\n      if (!throttledListRefresh) {\n        return;\n      }\n      setReloadEntireList(false);\n      fetchWorkflowApprovals();\n    })();\n  }, [throttledListRefresh, fetchWorkflowApprovals]);\n\n  useEffect(\n    () => {\n      if (!(lastMessage?.type === 'workflow_approval')) {\n        return;\n      }\n\n      const index = workflowApprovals.findIndex(\n        (p) => p.id === lastMessage.unified_job_id\n      );\n\n      if (\n        (index > -1 &&\n          !['new', 'pending', 'waiting', 'running'].includes(\n            lastMessage.status\n          )) ||\n        (index === -1 && lastMessage.status === 'pending')\n      ) {\n        setReloadEntireList(true);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps,\n    [lastMessage]\n  );\n\n  return workflowApprovals;\n}\n"],"mappings":"wTAAA,OAASA,QAAQ,CAAEC,SAAS,KAAQ,OAAO,CAC3C,MAAO,CAAAC,YAAY,KAAM,oBAAoB,CAC7C,MAAO,CAAAC,WAAW,KAAM,mBAAmB,CAE3C,cAAe,SAAS,CAAAC,sBAAsBA,CAC5CC,wBAAwB,CACxBC,sBAAsB,CACtB,CACA,IAAAC,SAAA,CAAkDP,QAAQ,CACxDK,wBACF,CAAC,CAAAG,UAAA,CAAAC,cAAA,CAAAF,SAAA,IAFMG,iBAAiB,CAAAF,UAAA,IAAEG,oBAAoB,CAAAH,UAAA,IAG9C,IAAAI,UAAA,CAAgDZ,QAAQ,CAAC,KAAK,CAAC,CAAAa,UAAA,CAAAJ,cAAA,CAAAG,UAAA,IAAxDE,gBAAgB,CAAAD,UAAA,IAAEE,mBAAmB,CAAAF,UAAA,IAC5C,GAAM,CAAAG,oBAAoB,CAAGb,WAAW,CAACW,gBAAgB,CAAE,IAAI,CAAC,CAChE,GAAM,CAAAG,WAAW,CAAGf,YAAY,CAAC,CAC/BgB,IAAI,CAAE,CAAC,gBAAgB,CAAC,CACxBC,OAAO,CAAE,CAAC,iBAAiB,CAC7B,CAAC,CAAC,CAEFlB,SAAS,CAAC,UAAM,CACdU,oBAAoB,CAACN,wBAAwB,CAAC,CAChD,CAAC,CAAE,CAACA,wBAAwB,CAAC,CAAC,CAE9BJ,SAAS,CAAC,UAAM,CACdmB,iBAAA,cAAAC,mBAAA,CAAAC,IAAA,CAAC,SAAAC,QAAA,SAAAF,mBAAA,CAAAG,IAAA,UAAAC,SAAAC,QAAA,kBAAAA,QAAA,CAAAC,IAAA,CAAAD,QAAA,CAAAE,IAAA,YACMZ,oBAAoB,EAAAU,QAAA,CAAAE,IAAA,iBAAAF,QAAA,CAAAG,MAAA,kBAGzBd,mBAAmB,CAAC,KAAK,CAAC,CAC1BT,sBAAsB,CAAC,CAAC,CAAC,wBAAAoB,QAAA,CAAAI,IAAA,OAAAP,OAAA,GAC1B,GAAE,CAAC,CACN,CAAC,CAAE,CAACP,oBAAoB,CAAEV,sBAAsB,CAAC,CAAC,CAElDL,SAAS,CACP,UAAM,CACJ,GAAI,EAAE,CAAAgB,WAAW,SAAXA,WAAW,iBAAXA,WAAW,CAAEc,IAAI,IAAK,mBAAmB,CAAC,CAAE,CAChD,OACF,CAEA,GAAM,CAAAC,KAAK,CAAGtB,iBAAiB,CAACuB,SAAS,CACvC,SAACC,CAAC,QAAK,CAAAA,CAAC,CAACC,EAAE,GAAKlB,WAAW,CAACmB,cAAc,EAC5C,CAAC,CAED,GACGJ,KAAK,CAAG,CAAC,CAAC,EACT,CAAC,CAAC,KAAK,CAAE,SAAS,CAAE,SAAS,CAAE,SAAS,CAAC,CAACK,QAAQ,CAChDpB,WAAW,CAACqB,MACd,CAAC,EACFN,KAAK,GAAK,CAAC,CAAC,EAAIf,WAAW,CAACqB,MAAM,GAAK,SAAU,CAClD,CACAvB,mBAAmB,CAAC,IAAI,CAAC,CAC3B,CACF,CAAC,CACD;AACA,CAACE,WAAW,CACd,CAAC,CAED,MAAO,CAAAP,iBAAiB,CAC1B"},"metadata":{},"sourceType":"module"}