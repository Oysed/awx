{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import{useLocation,useHistory}from'react-router-dom';import{parseQueryString,updateQueryString}from'util/qs';import useWebsocket from'hooks/useWebsocket';import useThrottle from'hooks/useThrottle';export default function useWsInventories(initialInventories,fetchInventories,fetchInventoriesById,qsConfig){var location=useLocation();var history=useHistory();var _useState=useState(initialInventories),_useState2=_slicedToArray(_useState,2),inventories=_useState2[0],setInventories=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),inventoriesToFetch=_useState4[0],setInventoriesToFetch=_useState4[1];var throttledInventoriesToFetch=useThrottle(inventoriesToFetch,5000);var lastMessage=useWebsocket({inventories:['status_changed'],jobs:['status_changed'],control:['limit_reached_1']});useEffect(function(){setInventories(initialInventories);},[initialInventories]);var enqueueId=function enqueueId(id){if(!inventoriesToFetch.includes(id)){setInventoriesToFetch(function(ids){return ids.concat(id);});}};useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var newInventories,updated;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(throttledInventoriesToFetch.length){_context.next=2;break;}return _context.abrupt(\"return\");case 2:setInventoriesToFetch([]);_context.next=5;return fetchInventoriesById(throttledInventoriesToFetch);case 5:newInventories=_context.sent;updated=_toConsumableArray(inventories);newInventories.forEach(function(inventory){var index=inventories.findIndex(function(i){return i.id===inventory.id;});if(index===-1){return;}updated[index]=inventory;});setInventories(updated);case 9:case\"end\":return _context.stop();}}},_callee);}))();},// eslint-disable-next-line react-hooks/exhaustive-deps\n[throttledInventoriesToFetch,fetchInventoriesById]);useEffect(function(){if(!(lastMessage!==null&&lastMessage!==void 0&&lastMessage.inventory_id)||lastMessage.type!=='inventory_update'&&lastMessage.group_name!=='inventories'){return;}var index=inventories.findIndex(function(p){return p.id===lastMessage.inventory_id;});if(index===-1){return;}var params=parseQueryString(qsConfig,location.search);var inventory=inventories[index];var updatedInventory=_objectSpread({},inventory);if(lastMessage.group_name==='inventories'&&lastMessage.status==='deleted'&&inventories.length===1&&params.page>1){// We've deleted the last inventory on this page so we'll\n// try to navigate back to the previous page\nvar qs=updateQueryString(qsConfig,location.search,{page:params.page-1});history.push(\"\".concat(location.pathname,\"?\").concat(qs));return;}if(lastMessage.group_name==='inventories'&&lastMessage.status==='deleted'){fetchInventories();return;}if(!['pending','waiting','running','pending_deletion'].includes(lastMessage.status)){enqueueId(lastMessage.inventory_id);return;}if(lastMessage.group_name==='inventories'&&lastMessage.status==='pending_deletion'){updatedInventory.pending_deletion=true;}if(lastMessage.group_name!=='inventories'){updatedInventory.isSourceSyncRunning=true;}setInventories([].concat(_toConsumableArray(inventories.slice(0,index)),[updatedInventory],_toConsumableArray(inventories.slice(index+1))));},// eslint-disable-next-line react-hooks/exhaustive-deps,\n[lastMessage]);return inventories;}","map":{"version":3,"names":["useState","useEffect","useLocation","useHistory","parseQueryString","updateQueryString","useWebsocket","useThrottle","useWsInventories","initialInventories","fetchInventories","fetchInventoriesById","qsConfig","location","history","_useState","_useState2","_slicedToArray","inventories","setInventories","_useState3","_useState4","inventoriesToFetch","setInventoriesToFetch","throttledInventoriesToFetch","lastMessage","jobs","control","enqueueId","id","includes","ids","concat","_asyncToGenerator","_regeneratorRuntime","mark","_callee","newInventories","updated","wrap","_callee$","_context","prev","next","length","abrupt","sent","_toConsumableArray","forEach","inventory","index","findIndex","i","stop","inventory_id","type","group_name","p","params","search","updatedInventory","_objectSpread","status","page","qs","push","pathname","pending_deletion","isSourceSyncRunning","slice"],"sources":["/awx_devel/awx/ui/src/screens/Inventory/InventoryList/useWsInventories.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { useLocation, useHistory } from 'react-router-dom';\nimport { parseQueryString, updateQueryString } from 'util/qs';\nimport useWebsocket from 'hooks/useWebsocket';\nimport useThrottle from 'hooks/useThrottle';\n\nexport default function useWsInventories(\n  initialInventories,\n  fetchInventories,\n  fetchInventoriesById,\n  qsConfig\n) {\n  const location = useLocation();\n  const history = useHistory();\n  const [inventories, setInventories] = useState(initialInventories);\n  const [inventoriesToFetch, setInventoriesToFetch] = useState([]);\n  const throttledInventoriesToFetch = useThrottle(inventoriesToFetch, 5000);\n  const lastMessage = useWebsocket({\n    inventories: ['status_changed'],\n    jobs: ['status_changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setInventories(initialInventories);\n  }, [initialInventories]);\n\n  const enqueueId = (id) => {\n    if (!inventoriesToFetch.includes(id)) {\n      setInventoriesToFetch((ids) => ids.concat(id));\n    }\n  };\n  useEffect(\n    () => {\n      (async () => {\n        if (!throttledInventoriesToFetch.length) {\n          return;\n        }\n        setInventoriesToFetch([]);\n        const newInventories = await fetchInventoriesById(\n          throttledInventoriesToFetch\n        );\n        const updated = [...inventories];\n        newInventories.forEach((inventory) => {\n          const index = inventories.findIndex((i) => i.id === inventory.id);\n          if (index === -1) {\n            return;\n          }\n          updated[index] = inventory;\n        });\n        setInventories(updated);\n      })();\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [throttledInventoriesToFetch, fetchInventoriesById]\n  );\n\n  useEffect(\n    () => {\n      if (\n        !lastMessage?.inventory_id ||\n        (lastMessage.type !== 'inventory_update' &&\n          lastMessage.group_name !== 'inventories')\n      ) {\n        return;\n      }\n      const index = inventories.findIndex(\n        (p) => p.id === lastMessage.inventory_id\n      );\n      if (index === -1) {\n        return;\n      }\n\n      const params = parseQueryString(qsConfig, location.search);\n\n      const inventory = inventories[index];\n      const updatedInventory = {\n        ...inventory,\n      };\n\n      if (\n        lastMessage.group_name === 'inventories' &&\n        lastMessage.status === 'deleted' &&\n        inventories.length === 1 &&\n        params.page > 1\n      ) {\n        // We've deleted the last inventory on this page so we'll\n        // try to navigate back to the previous page\n        const qs = updateQueryString(qsConfig, location.search, {\n          page: params.page - 1,\n        });\n        history.push(`${location.pathname}?${qs}`);\n        return;\n      }\n\n      if (\n        lastMessage.group_name === 'inventories' &&\n        lastMessage.status === 'deleted'\n      ) {\n        fetchInventories();\n        return;\n      }\n\n      if (\n        !['pending', 'waiting', 'running', 'pending_deletion'].includes(\n          lastMessage.status\n        )\n      ) {\n        enqueueId(lastMessage.inventory_id);\n        return;\n      }\n\n      if (\n        lastMessage.group_name === 'inventories' &&\n        lastMessage.status === 'pending_deletion'\n      ) {\n        updatedInventory.pending_deletion = true;\n      }\n\n      if (lastMessage.group_name !== 'inventories') {\n        updatedInventory.isSourceSyncRunning = true;\n      }\n\n      setInventories([\n        ...inventories.slice(0, index),\n        updatedInventory,\n        ...inventories.slice(index + 1),\n      ]);\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps,\n    [lastMessage]\n  );\n\n  return inventories;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}