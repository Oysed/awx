{"ast":null,"code":"import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import useWebsocket from'hooks/useWebsocket';import{WorkflowJobsAPI}from'api';var fetchWorkflowNodes=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(jobId){var pageNo,nodes,_yield$WorkflowJobsAP,data,_args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:pageNo=_args.length>1&&_args[1]!==undefined?_args[1]:1;nodes=_args.length>2&&_args[2]!==undefined?_args[2]:[];_context.next=4;return WorkflowJobsAPI.readNodes(jobId,{page_size:200,page:pageNo});case 4:_yield$WorkflowJobsAP=_context.sent;data=_yield$WorkflowJobsAP.data;if(!data.next){_context.next=8;break;}return _context.abrupt(\"return\",fetchWorkflowNodes(jobId,pageNo+1,nodes.concat(data.results)));case 8:return _context.abrupt(\"return\",nodes.concat(data.results));case 9:case\"end\":return _context.stop();}}},_callee);}));return function fetchWorkflowNodes(_x){return _ref.apply(this,arguments);};}();export default function useWsWorkflowOutput(workflowJobId,initialNodes){var _useState=useState(initialNodes),_useState2=_slicedToArray(_useState,2),nodes=_useState2[0],setNodes=_useState2[1];var lastMessage=useWebsocket({jobs:['status_changed'],control:['limit_reached_1']});useEffect(function(){setNodes(initialNodes);},[initialNodes]);useEffect(function(){function refreshNodeObjects(){return _refreshNodeObjects.apply(this,arguments);}function _refreshNodeObjects(){_refreshNodeObjects=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var refreshedNodes,updatedNodeObjects,updatedNodeObjectsMap;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:refreshedNodes=[];_context2.next=3;return fetchWorkflowNodes(workflowJobId);case 3:updatedNodeObjects=_context2.sent;updatedNodeObjectsMap=updatedNodeObjects.reduce(function(map,node){map[node.id]=node;return map;},{});nodes.forEach(function(node){if(node.id===1){// This is our artificial start node\nrefreshedNodes.push(_objectSpread({},node));}else{refreshedNodes.push(_objectSpread(_objectSpread({},node),{},{originalNodeObject:updatedNodeObjectsMap[node.originalNodeObject.id]}));}});setNodes(refreshedNodes);case 7:case\"end\":return _context2.stop();}}},_callee2);}));return _refreshNodeObjects.apply(this,arguments);}if((lastMessage===null||lastMessage===void 0?void 0:lastMessage.unified_job_id)===workflowJobId&&['successful','failed','error','cancelled'].includes(lastMessage.status)){refreshNodeObjects();}else{if(!nodes||nodes.length===0||(lastMessage===null||lastMessage===void 0?void 0:lastMessage.workflow_job_id)!==workflowJobId){return;}var index=nodes.findIndex(function(node){var _node$originalNodeObj;return(node===null||node===void 0?void 0:(_node$originalNodeObj=node.originalNodeObject)===null||_node$originalNodeObj===void 0?void 0:_node$originalNodeObj.id)===lastMessage.workflow_node_id;});if(index>-1){setNodes(updateNode(nodes,index,lastMessage));}}},[lastMessage]// eslint-disable-line react-hooks/exhaustive-deps\n);return nodes;}function updateNode(nodes,index,message){var _nodes$index,_nodes$index2,_nodes$index2$origina,_nodes$index3,_nodes$index3$origina,_nodes$index3$origina2,_nodes$index4;var node=_objectSpread(_objectSpread({},nodes[index]),{},{originalNodeObject:_objectSpread(_objectSpread({},(_nodes$index=nodes[index])===null||_nodes$index===void 0?void 0:_nodes$index.originalNodeObject),{},{job:message.unified_job_id,summary_fields:_objectSpread(_objectSpread({},(_nodes$index2=nodes[index])===null||_nodes$index2===void 0?void 0:(_nodes$index2$origina=_nodes$index2.originalNodeObject)===null||_nodes$index2$origina===void 0?void 0:_nodes$index2$origina.summary_fields),{},{job:_objectSpread(_objectSpread({},(_nodes$index3=nodes[index])===null||_nodes$index3===void 0?void 0:(_nodes$index3$origina=_nodes$index3.originalNodeObject)===null||_nodes$index3$origina===void 0?void 0:(_nodes$index3$origina2=_nodes$index3$origina.summary_fields)===null||_nodes$index3$origina2===void 0?void 0:_nodes$index3$origina2.job),{},{id:message.unified_job_id,status:message.status,type:message.type})})}),job:_objectSpread(_objectSpread({},(_nodes$index4=nodes[index])===null||_nodes$index4===void 0?void 0:_nodes$index4.job),{},{id:message.unified_job_id,status:message.status,type:message.type})});return[].concat(_toConsumableArray(nodes.slice(0,index)),[node],_toConsumableArray(nodes.slice(index+1)));}","map":{"version":3,"names":["useState","useEffect","useWebsocket","WorkflowJobsAPI","fetchWorkflowNodes","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","jobId","pageNo","nodes","_yield$WorkflowJobsAP","data","_args","arguments","wrap","_callee$","_context","prev","next","length","undefined","readNodes","page_size","page","sent","abrupt","concat","results","stop","_x","apply","useWsWorkflowOutput","workflowJobId","initialNodes","_useState","_useState2","_slicedToArray","setNodes","lastMessage","jobs","control","refreshNodeObjects","_refreshNodeObjects","_callee2","refreshedNodes","updatedNodeObjects","updatedNodeObjectsMap","_callee2$","_context2","reduce","map","node","id","forEach","push","_objectSpread","originalNodeObject","unified_job_id","includes","status","workflow_job_id","index","findIndex","_node$originalNodeObj","workflow_node_id","updateNode","message","_nodes$index","_nodes$index2","_nodes$index2$origina","_nodes$index3","_nodes$index3$origina","_nodes$index3$origina2","_nodes$index4","job","summary_fields","type","_toConsumableArray","slice"],"sources":["/awx_devel/awx/ui/src/screens/Job/WorkflowOutput/useWsWorkflowOutput.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport useWebsocket from 'hooks/useWebsocket';\nimport { WorkflowJobsAPI } from 'api';\n\nconst fetchWorkflowNodes = async (jobId, pageNo = 1, nodes = []) => {\n  const { data } = await WorkflowJobsAPI.readNodes(jobId, {\n    page_size: 200,\n    page: pageNo,\n  });\n\n  if (data.next) {\n    return fetchWorkflowNodes(jobId, pageNo + 1, nodes.concat(data.results));\n  }\n  return nodes.concat(data.results);\n};\n\nexport default function useWsWorkflowOutput(workflowJobId, initialNodes) {\n  const [nodes, setNodes] = useState(initialNodes);\n  const lastMessage = useWebsocket({\n    jobs: ['status_changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setNodes(initialNodes);\n  }, [initialNodes]);\n\n  useEffect(\n    () => {\n      async function refreshNodeObjects() {\n        const refreshedNodes = [];\n        const updatedNodeObjects = await fetchWorkflowNodes(workflowJobId);\n        const updatedNodeObjectsMap = updatedNodeObjects.reduce((map, node) => {\n          map[node.id] = node;\n          return map;\n        }, {});\n        nodes.forEach((node) => {\n          if (node.id === 1) {\n            // This is our artificial start node\n            refreshedNodes.push({\n              ...node,\n            });\n          } else {\n            refreshedNodes.push({\n              ...node,\n              originalNodeObject:\n                updatedNodeObjectsMap[node.originalNodeObject.id],\n            });\n          }\n        });\n        setNodes(refreshedNodes);\n      }\n\n      if (\n        lastMessage?.unified_job_id === workflowJobId &&\n        ['successful', 'failed', 'error', 'cancelled'].includes(\n          lastMessage.status\n        )\n      ) {\n        refreshNodeObjects();\n      } else {\n        if (\n          !nodes ||\n          nodes.length === 0 ||\n          lastMessage?.workflow_job_id !== workflowJobId\n        ) {\n          return;\n        }\n\n        const index = nodes.findIndex(\n          (node) =>\n            node?.originalNodeObject?.id === lastMessage.workflow_node_id\n        );\n\n        if (index > -1) {\n          setNodes(updateNode(nodes, index, lastMessage));\n        }\n      }\n    },\n    [lastMessage] // eslint-disable-line react-hooks/exhaustive-deps\n  );\n\n  return nodes;\n}\n\nfunction updateNode(nodes, index, message) {\n  const node = {\n    ...nodes[index],\n    originalNodeObject: {\n      ...nodes[index]?.originalNodeObject,\n      job: message.unified_job_id,\n      summary_fields: {\n        ...nodes[index]?.originalNodeObject?.summary_fields,\n        job: {\n          ...nodes[index]?.originalNodeObject?.summary_fields?.job,\n          id: message.unified_job_id,\n          status: message.status,\n          type: message.type,\n        },\n      },\n    },\n    job: {\n      ...nodes[index]?.job,\n      id: message.unified_job_id,\n      status: message.status,\n      type: message.type,\n    },\n  };\n\n  return [...nodes.slice(0, index), node, ...nodes.slice(index + 1)];\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}