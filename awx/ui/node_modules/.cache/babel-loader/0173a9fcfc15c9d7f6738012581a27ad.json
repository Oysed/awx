{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import{useLocation}from'react-router-dom';import useWebsocket from'hooks/useWebsocket';import useThrottle from'hooks/useThrottle';import{parseQueryString}from'util/qs';import sortJobs from'./sortJobs';export default function useWsJobs(initialJobs,fetchJobsById,qsConfig){var location=useLocation();var _useState=useState(initialJobs),_useState2=_slicedToArray(_useState,2),jobs=_useState2[0],setJobs=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),jobsToFetch=_useState4[0],setJobsToFetch=_useState4[1];var throttledJobsToFetch=useThrottle(jobsToFetch,5000);var lastMessage=useWebsocket({jobs:['status_changed'],schedules:['changed'],control:['limit_reached_1']});useEffect(function(){setJobs(initialJobs);},[initialJobs]);var enqueueJobId=function enqueueJobId(id){if(!jobsToFetch.includes(id)){setJobsToFetch(function(ids){return ids.concat(id);});}};useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var newJobs,deduplicated,params;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(throttledJobsToFetch.length){_context.next=2;break;}return _context.abrupt(\"return\");case 2:setJobsToFetch([]);_context.next=5;return fetchJobsById(throttledJobsToFetch);case 5:newJobs=_context.sent;deduplicated=newJobs.filter(function(job){return!jobs.find(function(j){return j.id===job.id;});});if(deduplicated.length){params=parseQueryString(qsConfig,location.search);setJobs(sortJobs([].concat(_toConsumableArray(deduplicated),_toConsumableArray(jobs)),params));}case 8:case\"end\":return _context.stop();}}},_callee);}))();},[throttledJobsToFetch,fetchJobsById]);// eslint-disable-line react-hooks/exhaustive-deps\nuseEffect(function(){if(!lastMessage||!lastMessage.unified_job_id){return;}var params=parseQueryString(qsConfig,location.search);var jobId=lastMessage.unified_job_id;var index=jobs.findIndex(function(j){return j.id===jobId;});if(index>-1){setJobs(sortJobs(updateJob(jobs,index,lastMessage),params));}else{enqueueJobId(lastMessage.unified_job_id);}},[lastMessage]);// eslint-disable-line react-hooks/exhaustive-deps\nreturn jobs;}function updateJob(jobs,index,message){var job=_objectSpread(_objectSpread({},jobs[index]),{},{status:message.status,finished:message.finished});return[].concat(_toConsumableArray(jobs.slice(0,index)),[job],_toConsumableArray(jobs.slice(index+1)));}","map":{"version":3,"names":["useState","useEffect","useLocation","useWebsocket","useThrottle","parseQueryString","sortJobs","useWsJobs","initialJobs","fetchJobsById","qsConfig","location","_useState","_useState2","_slicedToArray","jobs","setJobs","_useState3","_useState4","jobsToFetch","setJobsToFetch","throttledJobsToFetch","lastMessage","schedules","control","enqueueJobId","id","includes","ids","concat","_asyncToGenerator","_regeneratorRuntime","mark","_callee","newJobs","deduplicated","params","wrap","_callee$","_context","prev","next","length","abrupt","sent","filter","job","find","j","search","_toConsumableArray","stop","unified_job_id","jobId","index","findIndex","updateJob","message","_objectSpread","status","finished","slice"],"sources":["/awx_devel/awx/ui/src/components/JobList/useWsJobs.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport useWebsocket from 'hooks/useWebsocket';\nimport useThrottle from 'hooks/useThrottle';\nimport { parseQueryString } from 'util/qs';\nimport sortJobs from './sortJobs';\n\nexport default function useWsJobs(initialJobs, fetchJobsById, qsConfig) {\n  const location = useLocation();\n  const [jobs, setJobs] = useState(initialJobs);\n  const [jobsToFetch, setJobsToFetch] = useState([]);\n  const throttledJobsToFetch = useThrottle(jobsToFetch, 5000);\n  const lastMessage = useWebsocket({\n    jobs: ['status_changed'],\n    schedules: ['changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setJobs(initialJobs);\n  }, [initialJobs]);\n\n  const enqueueJobId = (id) => {\n    if (!jobsToFetch.includes(id)) {\n      setJobsToFetch((ids) => ids.concat(id));\n    }\n  };\n  useEffect(() => {\n    (async () => {\n      if (!throttledJobsToFetch.length) {\n        return;\n      }\n      setJobsToFetch([]);\n      const newJobs = await fetchJobsById(throttledJobsToFetch);\n      const deduplicated = newJobs.filter(\n        (job) => !jobs.find((j) => j.id === job.id)\n      );\n      if (deduplicated.length) {\n        const params = parseQueryString(qsConfig, location.search);\n        setJobs(sortJobs([...deduplicated, ...jobs], params));\n      }\n    })();\n  }, [throttledJobsToFetch, fetchJobsById]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  useEffect(() => {\n    if (!lastMessage || !lastMessage.unified_job_id) {\n      return;\n    }\n    const params = parseQueryString(qsConfig, location.search);\n    const jobId = lastMessage.unified_job_id;\n    const index = jobs.findIndex((j) => j.id === jobId);\n\n    if (index > -1) {\n      setJobs(sortJobs(updateJob(jobs, index, lastMessage), params));\n    } else {\n      enqueueJobId(lastMessage.unified_job_id);\n    }\n  }, [lastMessage]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  return jobs;\n}\n\nfunction updateJob(jobs, index, message) {\n  const job = {\n    ...jobs[index],\n    status: message.status,\n    finished: message.finished,\n  };\n  return [...jobs.slice(0, index), job, ...jobs.slice(index + 1)];\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}