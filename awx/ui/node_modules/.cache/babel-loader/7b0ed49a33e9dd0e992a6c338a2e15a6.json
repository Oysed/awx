{"ast":null,"code":"import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _taggedTemplateLiteral from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js\";var _templateObject,_templateObject2;import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import React,{useEffect,useReducer}from'react';import styled from'styled-components';import{CardBody as PFCardBody}from'@patternfly/react-core';import{WorkflowDispatchContext,WorkflowStateContext}from'contexts/Workflow';import{layoutGraph}from'components/Workflow/WorkflowUtils';import ContentError from'components/ContentError';import ContentLoading from'components/ContentLoading';import workflowReducer,{initReducer}from'components/Workflow/workflowReducer';import{WorkflowJobsAPI}from'api';import WorkflowOutputGraph from'./WorkflowOutputGraph';import WorkflowOutputToolbar from'./WorkflowOutputToolbar';import useWsWorkflowOutput from'./useWsWorkflowOutput';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var CardBody=styled(PFCardBody)(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  display: flex;\\n  flex-direction: column;\\n  height: calc(100vh - 240px);\\n\"])));var Wrapper=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  display: flex;\\n  flex-flow: column;\\n  height: 100%;\\n  position: relative;\\n\"])));var fetchWorkflowNodes=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(jobId){var pageNo,nodes,_yield$WorkflowJobsAP,data,_args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:pageNo=_args.length>1&&_args[1]!==undefined?_args[1]:1;nodes=_args.length>2&&_args[2]!==undefined?_args[2]:[];_context.next=4;return WorkflowJobsAPI.readNodes(jobId,{page_size:200,page:pageNo});case 4:_yield$WorkflowJobsAP=_context.sent;data=_yield$WorkflowJobsAP.data;if(!data.next){_context.next=8;break;}return _context.abrupt(\"return\",fetchWorkflowNodes(jobId,pageNo+1,nodes.concat(data.results)));case 8:return _context.abrupt(\"return\",nodes.concat(data.results));case 9:case\"end\":return _context.stop();}}},_callee);}));return function fetchWorkflowNodes(_x){return _ref.apply(this,arguments);};}();function WorkflowOutput(_ref2){var job=_ref2.job;var _useReducer=useReducer(workflowReducer,{},initReducer),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var contentError=state.contentError,isLoading=state.isLoading,links=state.links,nodePositions=state.nodePositions,nodes=state.nodes;useEffect(function(){function fetchData(){return _fetchData.apply(this,arguments);}function _fetchData(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var workflowNodes;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return fetchWorkflowNodes(job.id);case 3:workflowNodes=_context2.sent;dispatch({type:'GENERATE_NODES_AND_LINKS',nodes:workflowNodes});_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2[\"catch\"](0);dispatch({type:'SET_CONTENT_ERROR',value:_context2.t0});case 10:_context2.prev=10;dispatch({type:'SET_IS_LOADING',value:false});return _context2.finish(10);case 13:case\"end\":return _context2.stop();}}},_callee2,null,[[0,7,10,13]]);}));return _fetchData.apply(this,arguments);}dispatch({type:'RESET'});fetchData();},[job.id]);// Update positions of nodes/links\nuseEffect(function(){if(nodes){var newNodePositions={};var g=layoutGraph(nodes,links);g.nodes().forEach(function(node){newNodePositions[node]=g.node(node);});dispatch({type:'SET_NODE_POSITIONS',value:newNodePositions});}},[job.id,links,nodes]);var updatedNodes=useWsWorkflowOutput(job.id,nodes);useEffect(function(){dispatch({type:'SET_NODES',value:updatedNodes});},[updatedNodes]);if(isLoading){return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentLoading,{})});}if(contentError){return/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsx(ContentError,{error:contentError})});}return/*#__PURE__*/_jsx(WorkflowStateContext.Provider,{value:state,children:/*#__PURE__*/_jsx(WorkflowDispatchContext.Provider,{value:dispatch,children:/*#__PURE__*/_jsx(CardBody,{children:/*#__PURE__*/_jsxs(Wrapper,{children:[/*#__PURE__*/_jsx(WorkflowOutputToolbar,{job:job}),nodePositions&&/*#__PURE__*/_jsx(WorkflowOutputGraph,{})]})})})});}export default WorkflowOutput;","map":{"version":3,"names":["React","useEffect","useReducer","styled","CardBody","PFCardBody","WorkflowDispatchContext","WorkflowStateContext","layoutGraph","ContentError","ContentLoading","workflowReducer","initReducer","WorkflowJobsAPI","WorkflowOutputGraph","WorkflowOutputToolbar","useWsWorkflowOutput","jsx","_jsx","jsxs","_jsxs","_templateObject","_taggedTemplateLiteral","Wrapper","div","_templateObject2","fetchWorkflowNodes","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","jobId","pageNo","nodes","_yield$WorkflowJobsAP","data","_args","arguments","wrap","_callee$","_context","prev","next","length","undefined","readNodes","page_size","page","sent","abrupt","concat","results","stop","_x","apply","WorkflowOutput","_ref2","job","_useReducer","_useReducer2","_slicedToArray","state","dispatch","contentError","isLoading","links","nodePositions","fetchData","_fetchData","_callee2","workflowNodes","_callee2$","_context2","id","type","t0","value","finish","newNodePositions","g","forEach","node","updatedNodes","children","error","Provider"],"sources":["/awx_devel/awx/ui/src/screens/Job/WorkflowOutput/WorkflowOutput.js"],"sourcesContent":["import React, { useEffect, useReducer } from 'react';\n\nimport styled from 'styled-components';\nimport { shape } from 'prop-types';\nimport { CardBody as PFCardBody } from '@patternfly/react-core';\nimport {\n  WorkflowDispatchContext,\n  WorkflowStateContext,\n} from 'contexts/Workflow';\nimport { layoutGraph } from 'components/Workflow/WorkflowUtils';\nimport ContentError from 'components/ContentError';\nimport ContentLoading from 'components/ContentLoading';\nimport workflowReducer, {\n  initReducer,\n} from 'components/Workflow/workflowReducer';\nimport { WorkflowJobsAPI } from 'api';\nimport WorkflowOutputGraph from './WorkflowOutputGraph';\nimport WorkflowOutputToolbar from './WorkflowOutputToolbar';\nimport useWsWorkflowOutput from './useWsWorkflowOutput';\n\nconst CardBody = styled(PFCardBody)`\n  display: flex;\n  flex-direction: column;\n  height: calc(100vh - 240px);\n`;\n\nconst Wrapper = styled.div`\n  display: flex;\n  flex-flow: column;\n  height: 100%;\n  position: relative;\n`;\n\nconst fetchWorkflowNodes = async (jobId, pageNo = 1, nodes = []) => {\n  const { data } = await WorkflowJobsAPI.readNodes(jobId, {\n    page_size: 200,\n    page: pageNo,\n  });\n\n  if (data.next) {\n    return fetchWorkflowNodes(jobId, pageNo + 1, nodes.concat(data.results));\n  }\n  return nodes.concat(data.results);\n};\n\nfunction WorkflowOutput({ job }) {\n  const [state, dispatch] = useReducer(workflowReducer, {}, initReducer);\n  const { contentError, isLoading, links, nodePositions, nodes } = state;\n\n  useEffect(() => {\n    async function fetchData() {\n      try {\n        const workflowNodes = await fetchWorkflowNodes(job.id);\n        dispatch({\n          type: 'GENERATE_NODES_AND_LINKS',\n          nodes: workflowNodes,\n        });\n      } catch (error) {\n        dispatch({ type: 'SET_CONTENT_ERROR', value: error });\n      } finally {\n        dispatch({ type: 'SET_IS_LOADING', value: false });\n      }\n    }\n    dispatch({ type: 'RESET' });\n    fetchData();\n  }, [job.id]);\n\n  // Update positions of nodes/links\n  useEffect(() => {\n    if (nodes) {\n      const newNodePositions = {};\n      const g = layoutGraph(nodes, links);\n\n      g.nodes().forEach((node) => {\n        newNodePositions[node] = g.node(node);\n      });\n\n      dispatch({ type: 'SET_NODE_POSITIONS', value: newNodePositions });\n    }\n  }, [job.id, links, nodes]);\n\n  const updatedNodes = useWsWorkflowOutput(job.id, nodes);\n\n  useEffect(() => {\n    dispatch({ type: 'SET_NODES', value: updatedNodes });\n  }, [updatedNodes]);\n\n  if (isLoading) {\n    return (\n      <CardBody>\n        <ContentLoading />\n      </CardBody>\n    );\n  }\n\n  if (contentError) {\n    return (\n      <CardBody>\n        <ContentError error={contentError} />\n      </CardBody>\n    );\n  }\n\n  return (\n    <WorkflowStateContext.Provider value={state}>\n      <WorkflowDispatchContext.Provider value={dispatch}>\n        <CardBody>\n          <Wrapper>\n            <WorkflowOutputToolbar job={job} />\n            {nodePositions && <WorkflowOutputGraph />}\n          </Wrapper>\n        </CardBody>\n      </WorkflowDispatchContext.Provider>\n    </WorkflowStateContext.Provider>\n  );\n}\n\nWorkflowOutput.propTypes = {\n  job: shape().isRequired,\n};\n\nexport default WorkflowOutput;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}