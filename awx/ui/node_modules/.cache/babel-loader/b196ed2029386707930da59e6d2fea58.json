{"ast":null,"code":"import _objectSpread from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/awx_devel/awx/ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/awx_devel/awx/ui/node_modules/@babel/runtime/regenerator/index.js\";import{useState,useEffect}from'react';import useWebsocket from'hooks/useWebsocket';import{getJobModel}from'util/jobs';export default function useWsJob(initialJob){var _useState=useState(initialJob),_useState2=_slicedToArray(_useState,2),job=_useState2[0],setJob=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),pendingMessages=_useState4[0],setPendingMessages=_useState4[1];var lastMessage=useWebsocket({jobs:['status_changed'],control:['limit_reached_1']});useEffect(function(){setJob(initialJob);},[initialJob]);var processMessage=function processMessage(message){if(message.unified_job_id!==job.id){return;}if(['successful','failed','error','cancelled'].includes(message.status)){fetchJob();}setJob(updateJob(job,message));};function fetchJob(){return _fetchJob.apply(this,arguments);}function _fetchJob(){_fetchJob=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$getJobModel$re,data;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getJobModel(job.type).readDetail(job.id);case 2:_yield$getJobModel$re=_context.sent;data=_yield$getJobModel$re.data;setJob(data);case 5:case\"end\":return _context.stop();}}},_callee);}));return _fetchJob.apply(this,arguments);}useEffect(function(){if(!lastMessage){return;}if(job){processMessage(lastMessage);}else if(lastMessage.unified_job_id){setPendingMessages(pendingMessages.concat(lastMessage));}},[lastMessage]// eslint-disable-line react-hooks/exhaustive-deps\n);useEffect(function(){if(!job||!pendingMessages.length){return;}pendingMessages.forEach(function(message){processMessage(message);});setPendingMessages([]);},[job,pendingMessages]);// eslint-disable-line react-hooks/exhaustive-deps\nreturn job;}function updateJob(job,message){return _objectSpread(_objectSpread({},job),{},{finished:message.finished,status:message.status});}","map":{"version":3,"names":["useState","useEffect","useWebsocket","getJobModel","useWsJob","initialJob","_useState","_useState2","_slicedToArray","job","setJob","_useState3","_useState4","pendingMessages","setPendingMessages","lastMessage","jobs","control","processMessage","message","unified_job_id","id","includes","status","fetchJob","updateJob","_fetchJob","apply","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_yield$getJobModel$re","data","wrap","_callee$","_context","prev","next","type","readDetail","sent","stop","concat","length","forEach","_objectSpread","finished"],"sources":["/awx_devel/awx/ui/src/screens/Job/useWsJob.js"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport useWebsocket from 'hooks/useWebsocket';\nimport { getJobModel } from 'util/jobs';\n\nexport default function useWsJob(initialJob) {\n  const [job, setJob] = useState(initialJob);\n  const [pendingMessages, setPendingMessages] = useState([]);\n  const lastMessage = useWebsocket({\n    jobs: ['status_changed'],\n    control: ['limit_reached_1'],\n  });\n\n  useEffect(() => {\n    setJob(initialJob);\n  }, [initialJob]);\n\n  const processMessage = (message) => {\n    if (message.unified_job_id !== job.id) {\n      return;\n    }\n\n    if (\n      ['successful', 'failed', 'error', 'cancelled'].includes(message.status)\n    ) {\n      fetchJob();\n    }\n    setJob(updateJob(job, message));\n  };\n\n  async function fetchJob() {\n    const { data } = await getJobModel(job.type).readDetail(job.id);\n    setJob(data);\n  }\n\n  useEffect(\n    () => {\n      if (!lastMessage) {\n        return;\n      }\n      if (job) {\n        processMessage(lastMessage);\n      } else if (lastMessage.unified_job_id) {\n        setPendingMessages(pendingMessages.concat(lastMessage));\n      }\n    },\n    [lastMessage] // eslint-disable-line react-hooks/exhaustive-deps\n  );\n\n  useEffect(() => {\n    if (!job || !pendingMessages.length) {\n      return;\n    }\n    pendingMessages.forEach((message) => {\n      processMessage(message);\n    });\n    setPendingMessages([]);\n  }, [job, pendingMessages]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  return job;\n}\n\nfunction updateJob(job, message) {\n  return {\n    ...job,\n    finished: message.finished,\n    status: message.status,\n  };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}